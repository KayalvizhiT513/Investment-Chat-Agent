<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Chat Agent</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --surface: rgba(8, 12, 26, 0.85);
            --glass: rgba(10, 14, 32, 0.85);
            --border: rgba(108, 136, 242, 0.35);
            --accent: #64ffe1;
            --accent-2: #ff59c7;
            --text: #ecf2ff;
            --muted: #9caacf;
            --shadow: 0 25px 80px rgba(4, 6, 15, 0.65);
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            font-family: 'Space Grotesk', 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 400;
            background: radial-gradient(circle at top, #0b122b, #04030d 60%);
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            padding: 32px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            overflow-x: hidden;
        }
        body::before,
        body::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: linear-gradient(120deg, rgba(100, 255, 225, 0.08), rgba(255, 89, 199, 0.15));
            opacity: 0.2;
            pointer-events: none;
        }
        body::after {
            animation: drift 18s ease-in-out infinite alternate;
            mix-blend-mode: screen;
        }
        @keyframes drift {
            from { transform: translateY(-40px); }
            to { transform: translateY(40px); }
        }
        .orb {
            position: absolute;
            width: 420px;
            height: 420px;
            border-radius: 50%;
            filter: blur(90px);
            opacity: 0.55;
            z-index: 0;
        }
        .orb-one {
            top: -120px;
            left: -20px;
            background: radial-gradient(circle, rgba(82, 126, 255, 0.6), transparent 70%);
        }
        .orb-two {
            bottom: -150px;
            right: 0;
            background: radial-gradient(circle, rgba(255, 73, 151, 0.55), transparent 70%);
        }
        .app-shell {
            width: min(1300px, 95vw);
            height: min(900px, 95vh);
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 28px;
            position: relative;
            z-index: 2;
        }
        .side-panel {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(28px);
            min-height: 0;
        }
        .chat-panel {
            background: rgba(6, 10, 28, 0.85);
            border: 1px solid rgba(86, 117, 220, 0.35);
            border-radius: 36px;
            padding: 28px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            backdrop-filter: blur(24px);
            min-height: 0;
        }
        .brand-block h1 {
            margin: 12px 0 6px;
            font-size: 1.8rem;
            letter-spacing: -0.02em;
        }
        .brand-block .subtitle {
            color: var(--muted);
            margin: 0 0 16px;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(100, 255, 225, 0.1);
            border: 1px solid rgba(100, 255, 225, 0.4);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .live-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .mini-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            letter-spacing: 0.05em;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        .mini-badge.accent {
            border-color: rgba(255, 89, 199, 0.4);
            color: var(--accent-2);
        }
        .session-meta {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            margin-top: 18px;
        }
        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.55);
            margin-bottom: 6px;
        }
        .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .value.accent {
            color: var(--accent);
        }
        .control-deck {
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.02);
        }
        .toggle-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .toggle {
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: var(--text);
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle.active {
            background: linear-gradient(120deg, rgba(100, 255, 225, 0.2), rgba(255, 89, 199, 0.2));
            border-color: rgba(100, 255, 225, 0.8);
            color: var(--accent);
        }
        .metric-panel {
            background: rgba(5, 8, 22, 0.6);
            border-radius: 24px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .panel-header .timestamp {
            font-size: 12px;
            color: var(--muted);
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 14px;
        }
        .metric-card {
            padding: 16px;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(17, 21, 44, 0.9), rgba(12, 16, 32, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
            overflow: hidden;
        }
        .metric-card header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.6);
        }
        .metric-card .pill {
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
        }
        .metric-value {
            font-size: 1.4rem;
            margin: 16px 0 6px;
            font-weight: 600;
        }
        .metric-foot {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }
        .metric-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(100, 255, 225, 0.15), transparent 60%);
            pointer-events: none;
        }
        .metric-card.pulse {
            animation: pulseCard 1.2s ease;
        }
        @keyframes pulseCard {
            0% { box-shadow: 0 0 0 rgba(100, 255, 225, 0.2); }
            70% { box-shadow: 0 0 40px rgba(100, 255, 225, 0.3); }
            100% { box-shadow: 0 0 0 rgba(100, 255, 225, 0); }
        }
        .timeline {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.02);
        }
        .timeline-item {
            display: flex;
            gap: 12px;
            position: relative;
            padding-left: 24px;
            margin-bottom: 14px;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
        }
        .timeline-item .dot {
            position: absolute;
            left: 0;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 12px rgba(100, 255, 225, 0.7);
        }
        .timeline-item .title {
            font-weight: 600;
        }
        .timeline-item .meta {
            font-size: 13px;
            color: var(--muted);
        }
        .chat-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 999px;
            background: rgba(100, 255, 225, 0.12);
            border: 1px solid rgba(100, 255, 225, 0.3);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 12px;
        }
        .ping {
            display: inline-flex;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        .status-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.6);
        }
        .message-stack {
            flex: 1;
            margin-top: 20px;
            margin-bottom: 24px;
            padding: 8px 8px 8px 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .message {
            max-width: 78%;
            padding: 18px 20px;
            border-radius: 20px 20px 20px 6px;
            background: linear-gradient(145deg, #101736, #151c3a);
            border: 1px solid rgba(255, 255, 255, 0.07);
            position: relative;
            line-height: 1.6;
            animation: fadeInUp 0.35s ease;
        }
        .message::before {
            content: '';
            position: absolute;
            top: -18px;
            font-size: 10px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
        }
        .message.assistant {
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            background: linear-gradient(140deg, rgba(24, 30, 78, 0.9), rgba(13, 19, 44, 0.95));
        }
        .message.assistant::before {
            content: 'Analytics Agent';
            left: 12px;
            color: var(--accent);
        }
        .message.user {
            align-self: flex-end;
            border-radius: 20px 6px 20px 20px;
            background: linear-gradient(140deg, rgba(255, 89, 199, 0.9), rgba(104, 106, 255, 0.9));
            color: #fdf6ff;
        }
        .message.user::before {
            content: 'You';
            right: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        .message.intro {
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(12, 16, 40, 0.8);
            max-width: 100%;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message ul {
            margin: 12px 0 0;
            padding-left: 18px;
        }
        .message li {
            margin-bottom: 6px;
        }
        .callout {
            border-radius: 16px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .callout.warning {
            border-color: rgba(255, 175, 56, 0.5);
            background: rgba(255, 175, 56, 0.15);
        }
        .callout.accent {
            border-color: rgba(104, 255, 229, 0.5);
            background: rgba(104, 255, 229, 0.1);
        }
        .callout-title {
            font-size: 12px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.78);
        }
        .chip-tray {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        .prompt-chip {
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .prompt-chip:hover {
            border-color: rgba(100, 255, 225, 0.6);
            color: var(--accent);
        }
        .composer {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.02);
            padding: 14px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text);
            resize: none;
            font-family: inherit;
            font-size: 15px;
            outline: none;
        }
        .input-actions {
            display: flex;
            gap: 8px;
        }
        .ghost-btn {
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
        }
        .send-btn {
            border: none;
            border-radius: 20px;
            padding: 16px 28px;
            font-size: 14px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 600;
            background: linear-gradient(120deg, #64ffe1, #af68ff);
            color: #03050d;
            cursor: pointer;
            box-shadow: 0 12px 30px rgba(55, 188, 255, 0.35);
            transition: transform 0.2s ease;
        }
        .send-btn:hover {
            transform: translateY(-2px);
        }
        .message.thinking {
            color: rgba(255, 255, 255, 0.7);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .dots {
            display: inline-flex;
            gap: 4px;
        }
        .dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: blink 1.2s infinite ease-in-out;
        }
        .dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }
        .floating-card {
            position: absolute;
            right: 32px;
            bottom: 24px;
            padding: 16px 24px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(18px);
            box-shadow: 0 18px 40px rgba(5, 7, 14, 0.6);
            font-size: 14px;
            color: var(--text);
            z-index: 2;
        }
        .floating-card strong {
            font-size: 1.2rem;
            color: var(--accent);
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 999px;
        }
        @media (max-width: 1100px) {
            body {
                padding: 24px 18px;
            }
            .app-shell {
                grid-template-columns: 1fr;
                height: auto;
            }
            .message {
                max-width: 90%;
            }
            .floating-card {
                position: relative;
                right: auto;
                bottom: auto;
                margin-top: 18px;
            }
        }
        @media (max-width: 640px) {
            .chat-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .composer {
                flex-direction: column;
            }
            .send-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="orb orb-one"></div>
    <div class="orb orb-two"></div>
    <div class="app-shell">
        <aside class="side-panel">
            <div class="brand-block">
                <span class="badge">Live demo</span>
                <h1>Analytics Intelligence Desk</h1>
                <p class="subtitle">Conversational workflow for institutional performance requests.</p>
                <div class="session-meta">
                    <div>
                        <p class="eyebrow">Session</p>
                        <p class="value">INV-AGENT-204</p>
                    </div>
                    <div>
                        <p class="eyebrow">Latency</p>
                        <p class="value">42 ms</p>
                    </div>
                    <div>
                        <p class="eyebrow">Confidence</p>
                        <p class="value accent">99.1%</p>
                    </div>
                </div>
                <div class="live-badges">
                    <span class="mini-badge">Real portfolios</span>
                    <span class="mini-badge accent">Secure enclave</span>
                </div>
            </div>
            <div class="control-deck">
                <p class="eyebrow">Guardrails</p>
                <div class="toggle-row">
                    <button class="toggle active" data-toggle>Auto rerun</button>
                    <button class="toggle" data-toggle>Explain math</button>
                    <button class="toggle" data-toggle>Log macros</button>
                </div>
            </div>
            <div class="metric-panel">
                <div class="panel-header">
                    <p class="eyebrow">Latest analytics</p>
                    <span class="timestamp">Updated <span data-last-updated>—</span></span>
                </div>
                <div class="metric-grid">
                    <article class="metric-card" data-metric="volatility">
                        <header>
                            <span class="pill">Volatility</span>
                            <small>Annualized</small>
                        </header>
                        <p class="metric-value"><strong>—</strong></p>
                        <p class="metric-foot">Awaiting run</p>
                    </article>
                    <article class="metric-card" data-metric="sharpe_ratio">
                        <header>
                            <span class="pill">Sharpe</span>
                            <small>Risk-adjusted</small>
                        </header>
                        <p class="metric-value"><strong>—</strong></p>
                        <p class="metric-foot">Awaiting run</p>
                    </article>
                    <article class="metric-card" data-metric="beta">
                        <header>
                            <span class="pill">Beta</span>
                            <small>Benchmark</small>
                        </header>
                        <p class="metric-value"><strong>—</strong></p>
                        <p class="metric-foot">Awaiting run</p>
                    </article>
                    <article class="metric-card" data-metric="tracking_error">
                        <header>
                            <span class="pill">Tracking error</span>
                            <small>vs Benchmark</small>
                        </header>
                        <p class="metric-value"><strong>—</strong></p>
                        <p class="metric-foot">Awaiting run</p>
                    </article>
                    <article class="metric-card" data-metric="information_ratio">
                        <header>
                            <span class="pill">Info ratio</span>
                            <small>Signal</small>
                        </header>
                        <p class="metric-value"><strong>—</strong></p>
                        <p class="metric-foot">Awaiting run</p>
                    </article>
                </div>
            </div>
            <div class="timeline">
                <p class="eyebrow">Session timeline</p>
                <div class="timeline-item">
                    <span class="dot"></span>
                    <div>
                        <p class="title">Portfolio universe synced</p>
                        <p class="meta">08:58 · Supabase</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="dot"></span>
                    <div>
                        <p class="title">LLM guardrails warmed</p>
                        <p class="meta">08:59 · GPT-5 system prompt</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="dot"></span>
                    <div>
                        <p class="title">Risk API pinned</p>
                        <p class="meta">09:02 · Analytics API</p>
                    </div>
                </div>
            </div>
        </aside>
        <main class="chat-panel">
            <header class="chat-bar">
                <div class="status-pill">
                    <span class="ping"></span>
                    Connected to analytics fabric
                </div>
                <div class="status-meta">
                    <span>LLM · GPT-5</span>
                    <span>Data API · online</span>
                    <span>Analytics API · online</span>
                </div>
            </header>
            <section class="message-stack" id="chat-messages">
                <div class="message assistant intro">
                    <p>Welcome to the investment performance command center. I can reconcile portfolios, validate benchmark mappings, and stream analytics-grade metrics in real time.</p>
                    <ul>
                        <li>Contrast Sharpe ratio and volatility for Growth Plus.</li>
                        <li>Confirm your date window snaps to month-end.</li>
                        <li>Remap a benchmark when the name is off by one.</li>
                    </ul>
                </div>
            </section>
            <div class="chip-tray">
                <button class="prompt-chip" data-fill="Compute volatility for Growth Plus between 2021-01-31 and 2023-12-31">Volatility · Growth Plus FY21-23</button>
                <button class="prompt-chip" data-fill="Sharpe ratio for Growth Plus versus Secure Income benchmark between 2020-01-31 and 2022-12-31">Sharpe vs Secure Income</button>
                <button class="prompt-chip" data-fill="Tracking error for Global Dividend vs MSCI World between 2019-01-31 and 2024-09-30">Tracking error · Global Dividend</button>
            </div>
            <footer class="composer">
                <div class="input-wrapper">
                    <textarea id="message-input" rows="1" placeholder="Ask for a portfolio insight, e.g. &quot;Sharpe ratio for Growth Plus versus S&amp;P 500 in 2022&quot;" onkeydown="handleKeyPress(event)"></textarea>
                    <div class="input-actions">
                        <button type="button" class="ghost-btn">Context</button>
                        <button type="button" class="ghost-btn">Benchmarks</button>
                    </div>
                </div>
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </footer>
        </main>
    </div>
    <div class="floating-card">
        <p class="eyebrow">Broadcast</p>
        <p><strong>3</strong> stakeholders tuned into the live demo.</p>
        <p style="margin-top:6px;">Agent ready for conference stage.</p>
    </div>
    <script>
        const chatMessages = document.getElementById("chat-messages");
        const messageInput = document.getElementById("message-input");
        const lineBreak = String.fromCharCode(10);
        let conversationHistory = [];

        function resizeMessageInput() {
            messageInput.style.height = "auto";
            messageInput.style.height = Math.min(messageInput.scrollHeight, 220) + "px";
        }

        function escapeHTML(value) {
            return value
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll("\"", "&quot;")
                .replaceAll("'", "&#39;");
        }

        resizeMessageInput();
        messageInput.addEventListener("input", resizeMessageInput);

        document.querySelectorAll(".prompt-chip").forEach(chip => {
            chip.addEventListener("click", () => setInput(chip.dataset.fill));
        });

        document.querySelectorAll("[data-toggle]").forEach(toggle => {
            toggle.addEventListener("click", () => toggle.classList.toggle("active"));
        });

        chatMessages.addEventListener("click", event => {
            const suggestion = event.target.closest("[data-suggestion]");
            if (suggestion) {
                setInput(suggestion.dataset.suggestion);
            }
        });

        function parseContent(content) {
            if (content.startsWith("Missing parameters:")) {
                const raw = content.split(":")[1] || "";
                const params = raw.split(",").map(item => {
                    return item.trim().split(" ").map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(" ");
                });
                return '<div class="callout warning"><p class="callout-title">Missing parameters</p><ul>' + params.map(param => "<li>" + escapeHTML(param) + "</li>").join("") + "</ul></div>";
            }
            if (content.startsWith("Did you mean:")) {
                const options = content.replace("Did you mean:", "").split(",").map(item => item.trim()).filter(Boolean);
                return '<div class="callout accent"><p class="callout-title">Did you mean</p><ul>' + options.map(option => '<li data-suggestion="' + escapeHTML(option) + '">' + escapeHTML(option) + "</li>").join("") + "</ul></div>";
            }
            return content.split(lineBreak).join("<br>");
        }

        function setInput(value) {
            messageInput.value = value;
            resizeMessageInput();
            sendMessage();
        }

        function addMessage(content, sender) {
            const messageDiv = document.createElement("div");
            messageDiv.className = "message " + sender;
            messageDiv.innerHTML = parseContent(content);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function updateMetricCards(resultSet) {
            if (!resultSet) return;
            const timestampTarget = document.querySelector("[data-last-updated]");
            if (timestampTarget) {
                const now = new Date();
                timestampTarget.textContent = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
            }
            Object.entries(resultSet).forEach(([metric, value]) => {
                const card = document.querySelector('[data-metric="' + metric + '"]');
                if (!card) return;
                const strong = card.querySelector(".metric-value strong");
                const foot = card.querySelector(".metric-foot");
                if (typeof value === "number") {
                    strong.textContent = value.toFixed(4);
                } else if (value && typeof value === "object") {
                    strong.textContent = JSON.stringify(value);
                } else {
                    strong.textContent = value || "—";
                }
                if (foot) {
                    foot.textContent = "Latest insight from agent";
                }
                card.classList.remove("pulse");
                void card.offsetWidth;
                card.classList.add("pulse");
            });
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, "user");
            conversationHistory.push({ role: "user", content: message });
            messageInput.value = "";
            resizeMessageInput();

            const thinkingDiv = document.createElement("div");
            thinkingDiv.className = "message assistant thinking";
            const dots = document.createElement("span");
            dots.className = "dots";
            dots.innerHTML = "<span></span><span></span><span></span>";
            thinkingDiv.appendChild(dots);
            thinkingDiv.appendChild(document.createTextNode("Synthesizing analytics"));
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                const data = await response.json();
                const thinking = chatMessages.querySelector(".message.thinking");
                if (thinking) thinking.remove();

                addMessage(data.response, "assistant");

                if (data.results && data.results.results) {
                    updateMetricCards(data.results.results);
                }

                if (data.reset_history) {
                    conversationHistory = [];
                } else {
                    conversationHistory.push({ role: "assistant", content: data.response });
                }
            } catch (error) {
                const thinking = chatMessages.querySelector(".message.thinking");
                if (thinking) thinking.remove();
                addMessage("Sorry, there was an error processing your request.", "assistant");
                console.error("Error:", error);
            }
        }
    </script>
</body>
</html>
